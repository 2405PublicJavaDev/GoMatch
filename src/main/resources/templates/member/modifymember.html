<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원정보 수정</title>
    <link rel="stylesheet" href="../css/header-footer.css">
    <link rel="stylesheet" href="../css/member/modifymember.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>
<body>
<!-- 헤더 부분 -->
<th:block th:replace="fragments/header.html"></th:block>
<main>
    <div class="mypage-container">
        <div class="profile-img">
            <img id="profileImagePreview" th:src="${memberVO.profileImageUrl != null ? memberVO.profileImageUrl : '/img/기본프로필.png'}" alt="프로필 이미지">
        </div>
        <div class="profile-info">
            <h1 th:text="${memberName}">이름</h1>
            <h5 th:text="${memberNickName}">닉네임</h5>
            <p>개인정보 수정과 열람 내역을 확인 할 수 있습니다.</p>
        </div>
    </div>
    <div class="container">
        <div class="form-container">
            <h2>회원정보 수정</h2>
            <form id="updateForm" th:action="@{/member/modifymember}" th:object="${memberVO}" method="post" enctype="multipart/form-data">
                <label for="memberId">아이디</label>
                <input type="text" id="memberId" th:field="*{memberId}">
                <span id="idCheckResult"></span>

                <label for="memberName">이름</label>
                <input type="text" id="memberName" th:field="*{memberName}">

                <label for="memberNickName">닉네임</label>
                <input type="text" id="memberNickName" th:field="*{memberNickName}">
                <span id="nicknameCheckResult"></span>

                <label for="memberEmail">이메일</label>
                <div class="email-input">
                    <input type="email" id="memberEmail" th:field="*{memberEmail}">
                </div>
                <span id="emailCheckResult"></span>

                <label for="preferenceClub">선호 구단</label>
                <select id="preferenceClub" th:field="*{preferenceClub}">
                    <option value="">응원하는 구단을 선택해보세요!</option>
                    <option value="KIA">KIA</option>
                    <option value="삼성">삼성</option>
                    <option value="LG">LG</option>
                    <option value="두산">두산</option>
                    <option value="KT">KT</option>
                    <option value="SSG">SSG</option>
                    <option value="롯데">롯데</option>
                    <option value="한화">한화</option>
                    <option value="NC">NC</option>
                    <option value="키움">키움</option>
                    <option value="없음">없음</option>
                </select>

                <div class="form-group">
                    프로필 이미지
                    <label for="profileImageInput" class="custom-file-label">파일 선택</label>
                    <input type="file" id="profileImageInput" name="profileImage" accept="image/*">
                </div>

                <h3>비밀번호 변경</h3>
                <label for="currentPassword">현재 비밀번호</label>
                <input type="password" id="currentPassword" name="currentPassword">
                <span id="currentPasswordResult"></span>

                <label for="newPassword">새 비밀번호</label>
                <input type="password" id="newPassword" name="newPassword">

                <label for="confirmNewPassword">새 비밀번호 확인</label>
                <input type="password" id="confirmNewPassword" name="confirmNewPassword">
                <span id="passwordMatchResult"></span>

                <button type="submit" id="updateButton">수정 완료</button>
            </form>
        </div>
    </div>
</main>
<!-- 메인태그 닫고 로고 푸터 시작  -->
<th:block th:replace="fragments/footer.html"></th:block>

<script>
    $(document).ready(function() {
        let originalValues = {};
        let changedFields = new Set();
        let passwordChangeRequested = false;

        // 원래 값 저장
        $('form input, form select').each(function() {
            originalValues[this.id] = $(this).val();
        });

        // 값 변경 감지
        $('form input, form select').on('input change', function() {
            if ($(this).val() !== originalValues[this.id]) {
                changedFields.add(this.id);
            } else {
                changedFields.delete(this.id);
            }
            checkFormValidity();
        });

        // 비밀번호 필드 변경 감지
        $('#currentPassword, #newPassword, #confirmNewPassword').on('input', function() {
            passwordChangeRequested = $('#currentPassword').val() || $('#newPassword').val() || $('#confirmNewPassword').val();
            checkFormValidity();
        });

        function checkDuplicate(field, value) {
            if (value === originalValues[field]) {
                return; // 값이 변경되지 않았으면 중복 체크 불필요
            }
            $.ajax({
                url: '/member/checkDuplicate',
                type: 'GET',
                data: { field: field, value: value },
                success: function(response) {
                    var resultSpan = $('#' + field + 'CheckResult');
                    if(response.available) {
                        resultSpan.text('사용 가능합니다.').css('color', 'green');
                    } else {
                        resultSpan.text('이미 사용 중입니다.').css('color', 'red');
                    }
                    checkFormValidity();
                },
                error: function() {
                    $('#' + field + 'CheckResult').text('확인 중 오류가 발생했습니다.').css('color', 'red');
                }
            });
        }

        function checkPasswordMatch() {
            var newPassword = $('#newPassword').val();
            var confirmPassword = $('#confirmNewPassword').val();
            var $resultSpan = $('#passwordMatchResult');

            if(newPassword === confirmPassword) {
                $resultSpan.text('비밀번호가 일치합니다.').css('color', 'green');
            } else {
                $resultSpan.text('비밀번호가 일치하지 않습니다.').css('color', 'red');
            }
            checkFormValidity();
        }

        function checkCurrentPassword() {
            var currentPassword = $('#currentPassword').val();
            $.ajax({
                url: '/member/checkCurrentPassword',
                type: 'POST',
                data: { currentPassword: currentPassword },
                success: function(response) {
                    var $resultSpan = $('#currentPasswordResult');
                    if(response.valid) {
                        $resultSpan.text('비밀번호가 일치합니다.').css('color', 'green');
                    } else {
                        $resultSpan.text('비밀번호가 일치하지 않습니다.').css('color', 'red');
                    }
                    checkFormValidity();
                },
                error: function(xhr) {
                    $('#currentPasswordResult').text('확인 중 오류가 발생했습니다.').css('color', 'red');
                    console.error('Error checking current password:', xhr.responseText);
                }
            });
        }

        function checkFormValidity() {
            let isValid = changedFields.size > 0 || passwordChangeRequested;

            if (passwordChangeRequested) {
                isValid = isValid && $('#currentPassword').val() && $('#newPassword').val() === $('#confirmNewPassword').val();
            }

            $('#updateButton').prop('disabled', !isValid);
        }

        $('#memberId, #memberNickName, #memberEmail').on('blur', function() {
            var field = this.id.replace('member', '').toLowerCase();
            var value = $(this).val();
            if(value.length > 0) {
                checkDuplicate(field, value);
            }
        });

        $('#newPassword, #confirmNewPassword').on('input', checkPasswordMatch);
        $('#currentPassword').on('blur', function() {
            var currentPassword = $(this).val();
            if (currentPassword) {
                $.ajax({
                    url: '/member/checkCurrentPassword',
                    type: 'POST',
                    data: { currentPassword: currentPassword },
                    success: function(response) {
                        if (response.valid) {
                            $('#currentPasswordResult').text('비밀번호가 일치합니다.').css('color', 'green');
                        } else {
                            $('#currentPasswordResult').text('현재 비밀번호가 일치하지 않습니다.').css('color', 'red');
                        }
                    },
                    error: function() {
                        $('#currentPasswordResult').text('비밀번호 확인 중 오류가 발생했습니다.').css('color', 'red');
                    }
                });
            }
        });

        $('#uploadButton').click(function() {
            $('#profileImageInput').click();
        });

        // 이미지 프리뷰 기능
        $('#profileImageInput').on('change', function(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#profileImagePreview').attr('src', e.target.result);
                }
                reader.readAsDataURL(file);
            }
        });

        $('#updateForm').on('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            // 현재 비밀번호와 새 비밀번호 처리
            var currentPassword = $('#currentPassword').val();
            var newPassword = $('#newPassword').val();

            if (currentPassword || newPassword) {
                formData.set('currentPassword', currentPassword);
                formData.set('newPassword', newPassword);
            } else {
                formData.delete('currentPassword');
                formData.delete('newPassword');
            }

            // 프로필 이미지 처리
            var profileImage = $('#profileImageInput')[0].files[0];
            if (profileImage) {
                formData.set('profileImage', profileImage);
            } else {
                formData.delete('profileImage');
            }

            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    swal({
                        title: "성공!",
                        text: "회원정보가 성공적으로 수정되었습니다.",
                        icon: "success",
                    }).then(() => {
                        window.location.href = '/member/mypage';
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error response:', xhr.responseText);
                    swal("오류", "회원정보 수정 중 오류가 발생했습니다: " + xhr.responseText, "error");
                }
            });
        });
    });
</script>
</body>
</html>