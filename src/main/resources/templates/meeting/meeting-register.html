<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoMatch</title>
  <link rel="stylesheet" href="/css/meeting-register.css">
  <link rel="stylesheet" href="/css/header-footer.css">
</head>
<body>
<header>
  <nav>
    <div class="logo">
      <img src="/img/고매치로고.png" alt="야구 리그 로고">
    </div>
    <ul class="nav-links">
      <li><a href="#">일정/결과</a></li>
      <li><a href="#">굿즈</a></li>
      <li><a href="#">소모임</a></li>
      <li><a href="#">승부예측</a></li>
    </ul>
    <ul class="member-links">
      <li><a href="loginpage.html">로그인</a></li>
      <li><a href="#">회원가입</a></li>
    </ul>
  </nav>
</header>

<main>
  <h1>소모임 개설하기</h1>
  <form action="/meeting/register" method="post" onsubmit="combineAddress(); return validateForm()">
    <input type="hidden" value="{memberId}">

    <!-- 경기 날짜 선택 -->
    <div class="form-group">
      <label for="gameDate">경기 날짜</label>
      <input type="date" id="gameDate" name="gameDate" required>
    </div>

    <!-- 경기 정보 선택 -->
    <div class="form-group">
      <label for="gameNo">경기 정보</label>
      <select id="gameNo" name="gameNo" required>
        <option value="">경기를 선택하세요</option>
        <!-- 서버에서 받은 경기 리스트가 이곳에 추가됩니다 -->
      </select>
    </div>

    <!-- 응원하는 팀 선택 -->
    <div class="form-group">
      <label for="meetingTeamName">응원하는 팀명</label>
      <select id="meetingTeamName" name="meetingTeamName" required>
        <option value="">선택하세요</option>
        <option value="두산">두산 베어스</option>
        <option value="삼성">삼성 라이온즈</option>
        <option value="키움">키움 히어로즈</option>
        <option value="KT">KT 위즈</option>
        <option value="LG">LG 트윈스</option>
        <option value="NC">NC 다이노스</option>
        <option value="SSG">SSG 랜더스</option>
        <option value="롯데">롯데 자이언츠</option>
        <option value="KIA">KIA 타이거즈</option>
        <option value="한화">한화 이글스</option>
      </select>
    </div>


    <!-- 모임 시간 선택 -->
    <div class="form-group">
      <label for="meetingTime">모임 시간</label>
      <!-- 시, 분 선택 드롭다운 -->
      <select id="hourSelect">
        <option value="">--시--</option>
        <option value="09">09</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>
      <select id="minuteSelect">
        <option value="">--분--</option>
        <option value="00">00</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="40">40</option>
        <option value="50">50</option>
      </select>

      <!-- hidden 필드에 최종 시간 저장 -->
      <input type="hidden" id="meetingTime" name="meetingTime" required>
    </div>

    <!-- 모임 위치 검색 및 상세 주소 입력 -->
    <div class="form-group">
      <label for="meetingPlace">모임 위치</label>
      <input type="text" id="meetingPlace" name="meetingPlace" placeholder="주소를 검색하세요" required readonly>
      <input type="text" id="meetingPlaceDetail" name="meetingPlaceDetail" placeholder="상세 주소를 입력하세요">
      <button type="button" onclick="searchAddress();">검색</button>
    </div>

    <!-- 최대 참석 인원 -->
    <div class="form-group">
      <label for="meetingMaxPeople">최대 참석 인원</label>
      <input type="number" id="meetingMaxPeople" name="meetingMaxPeople" min="1" max="20" placeholder="최대 20명까지 입력 가능" required>
    </div>

    <!-- 모임 제목 -->
    <div class="form-group">
      <label for="meetingTitle">모임 제목</label>
      <input type="text" id="meetingTitle" name="meetingTitle" placeholder="모임의 제목을 입력해주세요" required>
    </div>

    <!-- 모임 내용 -->
    <div class="form-group">
      <label for="meetingContent">모임 내용</label>
      <textarea id="meetingContent" name="meetingContent" placeholder="모임의 내용을 입력해주세요" required></textarea>
    </div>

    <!-- 사진 첨부 -->
    <div class="form-group">
      <label for="groupImage">사진 첨부</label>
      <input type="file" id="groupImage" name="groupImage" accept="image/*">
    </div>

    <div class="buttons">
      <button type="submit" class="submit">등록</button>
      <button type="button" class="cancel" onclick="history.back()">취소</button>
    </div>
  </form>
</main>

<footer class="footer-page">
  <div class="footer-content">
    <div class="logo">
      <img src="img/고매치로고.png" alt="GoMatch 로고">
    </div>
    <div class="footer-text">
      <p>개인정보 처리방침</p>
      <p>(사)GoMatch｜서울 중구 남대문로 120 대경빌딩 3층｜02)1544-1515</p>
      <p>Copyright © GoMatch</p>
    </div>
  </div>
</footer>

<!-- Script 부분 -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // 오늘 날짜 이후로만 선택 가능하도록 설정
  const today = new Date();
  const sixMonthsLater = new Date();
  sixMonthsLater.setMonth(today.getMonth() + 6);

  const todayStr = today.toISOString().split('T')[0];
  const sixMonthsLaterStr = sixMonthsLater.toISOString().split('T')[0];

  document.getElementById('gameDate').setAttribute('min', todayStr);
  document.getElementById('gameDate').setAttribute('max', sixMonthsLaterStr);

  // 경기 날짜 선택 시 AJAX로 해당 날짜의 경기 정보 조회
  $('#gameDate').on('change', function() {
    const selectedDate = $(this).val();
    if (selectedDate) {
      $.ajax({
        url: '/meeting/games', // 서버의 매핑된 URL
        method: 'GET',
        data: { date: selectedDate },
        success: function(response) {
          $('#gameNo').empty(); // 기존 옵션 제거
          if (response.length > 0) {
            response.forEach(function(game) {
              const optionText = `${game.gameDate} ${game.gameTime} ${game.teamA} vs ${game.teamB} @ ${game.gameField}`;
              const option = `<option value="${game.gameNo}">${optionText}</option>`;
              $('#gameNo').append(option);
            });
          } else {
            $('#gameNo').append('<option value="">경기가 없습니다</option>');
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX 에러:', error);
        }
      });
    }
  });

  // 주소 검색 API 호출
  function searchAddress() {
    new daum.Postcode({
      oncomplete: function(data) {
        var addr = ''; // 주소 변수
        var extraAddr = ''; // 참고 항목 변수

        // 도로명 주소 선택 시
        if (data.userSelectedType === 'R') {
          addr = data.roadAddress;
          if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
            extraAddr += data.bname;
          }
          if (data.buildingName !== '' && data.apartment === 'Y') {
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          addr += (extraAddr !== '' ? ' (' + extraAddr + ')' : ''); // 상세 주소 추가
        } else {
          // 지번 주소 선택 시
          addr = data.jibunAddress;
        }

        // 주소 필드에 넣기
        document.querySelector("#meetingPlace").value = addr;
        document.querySelector("#meetingPlaceDetail").focus(); // 상세 주소 입력 필드로 포커스 이동
      }
    }).open();
  }

  // Form이 제출되기 전에 상세주소를 meetingPlace에 합쳐서 저장하는 함수
  function combineAddress() {
    var basicAddress = document.querySelector("#meetingPlace").value;
    var detailAddress = document.querySelector("#meetingPlaceDetail").value;

    // 기본 주소와 상세 주소를 합침
    document.querySelector("#meetingPlace").value = basicAddress + ' ' + detailAddress;
  }
  // 시, 분 선택 후 hidden input에 값 저장
  document.getElementById('hourSelect').addEventListener('change', updateMeetingTime);
  document.getElementById('minuteSelect').addEventListener('change', updateMeetingTime);

  function updateMeetingTime() {
    const hour = document.getElementById('hourSelect').value;
    const minute = document.getElementById('minuteSelect').value;

    if (hour && minute) {
      const meetingTime = hour + ':' + minute;
      document.getElementById('meetingTime').value = meetingTime;
      console.log('선택한 시간:', meetingTime);  // 선택한 시간 로그 출력
    }
  }
  // 경기 날짜 유효성 검사 함수
  function validateForm() {
    const gameDate = document.getElementById('gameDate').value;
    if (gameDate < todayStr) {
      alert("지난 날짜는 선택할 수 없습니다.");
      return false; // 제출 중지
    }
    return true;
  }
</script>
</body>
</html>
