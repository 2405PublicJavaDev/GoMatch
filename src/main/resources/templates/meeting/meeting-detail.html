<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>소모임 상세</title>
  <!-- 메인 css -->
  <link rel="stylesheet" href="/css/meeting/meeting-detail.css">
  <!-- 헤더/푸터 CSS-->
  <link rel="stylesheet" href="/css/header-footer.css">

</head>
<body>
<header>
  <nav>
    <div class="logo">
      <img src="/img/고매치로고.png" alt="야구 리그 로고">
    </div>
    <ul class="nav-links">
      <li><a href="/game/list">일정/결과</a></li>
      <li><a href="/goods/list">굿즈</a></li>
      <li><a href="/meeting/list">소모임</a></li>
      <li><a href="/matchPredict">승부예측</a></li>
    </ul>
    <ul class="member-links">
      <th:block th:if="${loggedIn}">
        <li class="member-link"><a th:href="@{/member/mypage}"> <span th:text="${memberNickName} + ' 님'"></span></a></li>
        <li class="member-link"><a href="#" onclick="confirmLogout(); return false;">로그아웃</a></li>
      </th:block>
      <th:block th:unless="${loggedIn}">
        <li class="member-link"><a th:href="@{/member/loginpage}">로그인</a></li>
        <li class="member-link"><a th:href="@{/member/joinmember}">회원가입</a></li>
      </th:block>
    </ul>
  </nav>
</header>

<main>
  <div class="main-container">
    <!-- 상단 배경 이미지 -->
    <div class="background-image">
      <img src="/img/baseballground.png" alt="경기장 이미지">
    </div>

    <div class="meeting-header">
      <div class="team-logo">
        <!-- 팀 로고 이미지 -->
        <img th:src="@{/img/{teamName}로고.png(teamName=${meeting.meetingTeamName})}" alt="팀 로고">
      </div>
      <div class="meeting-title">
        <h2 th:text="${meeting.meetingTitle}">글 제목</h2>
        <div class="top-buttons">
          <!-- 수정된 부분: 조건부 버튼 표시 -->
          <button th:if="${session.memberId == meeting.memberId}"
                  type="button" class="button-modify"
                  onclick="modifyMeeting()">수정</button>
          <button th:if="${session.memberId == meeting.memberId and (currentAttendeesCount == 1 or currentAttendeesCount == 0)}"
                  type="button" class="button-delete"
                  onclick="deleteMeeting()">삭제</button>
        </div>
      </div>
    </div>


    <div class="meeting-details">
      <!-- 경기 일정 출력 -->
      <div class="detail-item">
        <label>경기일정</label>
        <span id="game-info">경기 정보를 불러오는 중...</span>
      </div>

      <div class="detail-item">
        <label>작성자</label>
        <span th:text="${meeting.memberId}">홍길동</span>
      </div>
      <div class="detail-item">
        <label>모임장소</label>
        <span th:text="${meeting.meetingPlace}">잠실구장</span>
      </div>
      <div class="detail-item">
        <label>등록일</label>
        <span th:text="${#dates.format(meeting.regDate, 'MM/dd HH:mm:ss')}"></span>
      </div>
      <div class="detail-item">
        <label>모임일시</label>
        <span th:text="${#dates.format(meeting.meetingDate, 'MM월 dd일')}+'  ('+${meeting.meetingTime}+')'">13시 30분</span>
      </div>
      <div class="detail-item">
        <label>참석자 현황</label>
        <span th:text="${currentAttendeesCount} + ' / ' + ${meeting.meetingMaxPeople}">0 / 10</span>
      </div>
    </div>

    <div class="meeting-content">
      <p th:utext="${meeting.meetingContent}" class="formatted-text"></p>
    </div>
    <!-- 첨부파일 썸네일 출력 영역 -->
    <div class="meeting-files">
      <div id="thumbnailContainer" class="file-thumbnails">
        <div th:each="file : ${meetingFile}">
          <div class="file-thumbnail-wrapper">
            <img th:src="@{${file.webPath}}" alt="첨부파일 썸네일" class="thumbnail" onclick="openPopup(this.src)">
          </div>
        </div>
      </div>
    </div>

    <div class="buttons">
      <button type="button" class="button-join" onclick="attendMeeting()">참여</button>
      <button type="button" class="button-cancel" onclick="cancelMeeting()">취소</button>
      <button type="button" class="button-back" onclick="history.back()">이전</button>
    </div>

    <!-- 이미지 팝업을 위한 모달 -->
    <div id="popup" class="popup" onclick="closePopup()">
      <img id="popup-img" class="popup-img">
    </div>

    <hr>
    <h3>🙌함께해요🙌</h3>
    <div class="participant-list" th:if="${meetingAttendee.size() > 0}">
      <div class="participant" th:each="attendee : ${meetingAttendee}">
        <img th:src="${attendee.memberId == meeting.memberId ? '/img/host.png' : '/img/bat.png'}" alt="아이콘" class="icon">
        <span th:text="${attendee.memberNickname}">닉네임</span>
      </div>
    </div>
    <div class="no-participants" th:if="${meetingAttendee.size() == 0}">
      아직 참석자가 없습니다.<br>
      제일 먼저 참여하기를 눌러주세요👍
    </div>
</main>

<footer class="footer-page">
  <div class="footer-content">
    <div class="logo">
      <img src="/img/고매치로고.png" alt="GoMatch 로고">
    </div>
    <div class="footer-text">
      <p>게인정보 처리방침</p>
      <p>(사)GoMatch｜서울 종구 남대문로 120 대경빌딩 3층｜02)1544-1515</p>
      <p>Copyright © GoMatch</p>
    </div>
  </div>
</footer>
<script th:inline="javascript">
  var gameNo = /*[[${meeting.gameNo}]]*/ '';  // 서버에서 전달된 gameNo
  var meetingNo = /*[[${meeting.meetingNo}]]*/ '';  // 서버에서 전달된 meetingNo
  var loggedIn =true; // 서버에서 로그인 여부를 전달
</script>
<script>

  // 이미지 팝업 열기
  function openPopup(src) {
    const popup = document.getElementById('popup');
    const popupImg = document.getElementById('popup-img');
    popup.style.display = 'flex';  // 팝업을 표시
    popupImg.src = src;  // 팝업 이미지 경로 설정
  }

  // 이미지 팝업 닫기
  function closePopup() {
    const popup = document.getElementById('popup');
    popup.style.display = 'none';  // 팝업을 숨김
  }

  document.addEventListener('DOMContentLoaded', function () {
    // gameNo가 존재하는지 확인한 후 fetch 요청
    if (gameNo) {
      fetch(`/meeting/gameInfo?gameNo=${gameNo}`)
              .then(response => response.json())
              .then(gameInfo => {
                const gameInfoElement = document.getElementById('game-info');
                gameInfoElement.innerHTML = `${gameInfo.teamA} vs ${gameInfo.teamB} (${gameInfo.gameTime}, @ ${gameInfo.gameField})`;
              })
              .catch(error => {
                console.error('경기 정보 가져오기 중 오류 발생:', error);
                document.getElementById('game-info').textContent = '경기 정보를 불러오지 못했습니다.';
              });
    }
  });

  function attendMeeting() {
    // 로그인된 경우에만 참석 요청 처리
    if (confirm("참여하시겠습니까?")) {
      if (meetingNo) {
        fetch(`/meeting/attend?meetingNo=${meetingNo}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
                .then(response => {
                  // 상태 코드가 401인 경우 로그인 필요 안내
                  if (response.status === 401) {
                    return response.json().then(data => {
                      if (confirm(data.message)) {
                        window.location.href = '/member/loginpage';
                      }
                    });
                  }
                  return response.json();
                })
                .then(data => {
                  if (data && data.message) {
                    alert(data.message);
                    if (data.message === "참석이 완료되었습니다.") {
                      location.reload(); // 참석 완료 후 페이지 새로고침
                    }
                  }
                })
                .catch(error => {
                  console.error('참석 처리 중 오류 발생:', error);
                  alert('참석 처리 중 오류가 발생했습니다.');
                });
      } else {
        alert('소모임 정보를 찾을 수 없습니다.');
      }
    }
  }

  function modifyMeeting() {
    if (meetingNo) {
      window.location.href = `/meeting/modify/${meetingNo}`;
    } else {
      alert('소모임 정보를 찾을 수 없습니다.');
    }
  }

  // 참석 취소 요청 함수
  function cancelMeeting() {
    if (confirm("😢정말 참석을 취소하시겠습니까?😢")) {
      if (meetingNo) {
        fetch(`/meeting/cancel?meetingNo=${meetingNo}`, {
          method: 'POST',
        })
                .then(response => response.text())
                .then(message => {
                  alert(message);
                  if (message === "참석이 취소되었습니다.") {
                    location.reload(); // 참석 취소 후 페이지 새로고침
                  }
                })
                .catch(error => {
                  console.error('참석 취소 처리 중 오류 발생:', error);
                  alert('참석 취소 처리 중 오류가 발생했습니다.');
                });
      } else {
        alert('소모임 정보를 찾을 수 없습니다.');
      }
    }
  }

  function deleteMeeting() {
    if (confirm("정말로 소모임을 삭제하시겠습니까?")) {
      if (meetingNo) {
        fetch(`/meeting/delete/${meetingNo}`, {
          method: 'POST',
        })
                .then(() => {
                  // 삭제가 완료되었음을 알리고, 페이지 이동
                  alert("삭제가 완료되었습니다.");
                  window.location.href = "/meeting/list";
                })
                .catch(error => {
                  console.error('삭제 처리 중 오류 발생:', error);
                  alert('삭제 처리 중 오류가 발생했습니다.');
                });
      } else {
        alert('소모임 정보를 찾을 수 없습니다.');
      }
    }
  }



</script>
</body>
</html>
