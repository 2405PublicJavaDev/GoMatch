<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Match</title>
    <!-- 메인 css -->
    <link rel="stylesheet" href="/css/meeting/meeting-list.css">
    <!-- 헤더/푸터 CSS-->
    <link rel="stylesheet" href="/css/header-footer.css">
    <!-- FullCalendar CSS 로드 -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css' rel='stylesheet'/>
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<header>
    <nav>
        <div class="logo">
            <a th:href="@{/}"><img src="/img/고매치로고.png" alt="야구 리그 로고"></a>
        </div>
        <ul class="nav-links">
            <li><a href="/game/list">일정/결과</a></li>
            <li><a href="/goods/list">굿즈</a></li>
            <li><a href="/meeting/list">소모임</a></li>
            <li><a href="/matchPredict">승부예측</a></li>
        </ul>
        <ul class="member-links">
            <th:block th:if="${loggedIn}">
                <li class="member-link"><a th:href="@{/member/mypage}"><span th:text="${memberNickName + ' 님'}"></span></a></li>
                <li class="member-link"><a href="#" onclick="confirmLogout(); return false;">로그아웃</a></li>
            </th:block>
            <th:block th:unless="${loggedIn}">
                <li class="member-link"><a th:href="@{/member/loginpage}">로그인</a></li>
                <li class="member-link"><a th:href="@{/member/joinmember}">회원가입</a></li>
            </th:block>
        </ul>
    </nav>
    <script>
        function confirmLogout() {
            if (confirm("로그아웃 하시겠습니까?")) {
                window.location.href = "/member/logout";
            }
        }
    </script>
</header>

<main>
    <aside>
        <div id="aside-main">
            <div id="aside-content">
                <span>소모임</span>
                <hr  class="aside-header">
                <ul>
                    <li><a href="/meeting/list" >소모임</a></li>
                    <li><a href="/board/list">게시판</a></li>
                </ul>
            </div>
        </div>
    </aside>
    <div class="container">
        <h1>소모임 리스트</h1>

        <div class="content-container">
            <!-- 날짜별 달력 영역 -->
            <div class="calendar-container">
                <h3>날짜별</h3>
                <div id="calendar"></div>
                <p class="calendar-note">⚾경기가 있는 날입니다. 소모임을 개설할 수 있습니다.⚾</p>
            </div>

            <!-- 팀별 필터 영역 -->
            <div class="filter-container">
                <h3>팀별</h3>
                <div class="tags">
                    <!-- 전체 태그 -->
                    <div class="tag" onclick="filterByTeam('전체')">
                        <img src="/img/고매치로고.png" alt="전체"> 전체
                    </div>
                    <!-- 기아 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('기아')">
                        <img src="/img/기아로고.png" alt="기아"> 기아 타이거즈
                    </div>
                    <!-- 롯데 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('롯데')">
                        <img src="/img/롯데로고.png" alt="롯데"> 롯데 자이언츠
                    </div>
                    <!-- 삼성 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('삼성')">
                        <img src="/img/삼성로고.png" alt="삼성"> 삼성 라이온즈
                    </div>
                    <!-- 두산 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('두산')">
                        <img src="/img/두산로고.png" alt="두산"> 두산 베어스
                    </div>
                    <!-- KT 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('KT')">
                        <img src="/img/KT로고.png" alt="KT"> KT 위즈
                    </div>
                    <!-- SSG 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('SSG')">
                        <img src="/img/SSG로고.png" alt="SSG"> SSG 랜더스
                    </div>
                    <!-- NC 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('NC')">
                        <img src="/img/NC로고.png" alt="NC"> NC 다이노스
                    </div>
                    <!-- 한화 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('한화')">
                        <img src="/img/한화로고.png" alt="한화"> 한화 이글스
                    </div>
                    <!-- 키움 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('키움')">
                        <img src="/img/키움로고.png" alt="키움"> 키움 히어로즈
                    </div>
                    <!-- LG 팀 태그 -->
                    <div class="tag" onclick="filterByTeam('LG')">
                        <img src="/img/LG로고.png" alt="LG"> LG 트윈스
                    </div>
                </div>
            </div>
        </div>
        <!-- 소모임 개설하기 버튼 -->
        <button class="button" onclick="registerMeeting()">소모임 개설하기</button>
        <div class="meeting-info">
            <!-- 필터 정보 왼쪽 정렬 -->
            <span id="filter-info" class="filter-info">선택된 필터 : </span>

            <!-- Total 건수 가운데 정렬 -->
            <span class="total-count">* Total : <span id="total-count">0</span> 건</span>

            <!-- 페이지 표시 영역 오른쪽 정렬 -->
            <span class="page-info">Page : <span id="current-page">1</span> / <span id="total-pages">1</span></span>
        </div>

        <div id="meeting-list" class="items">
            <!-- 반복문으로 각 소모임 정보 출력 -->
            <div th:each="meeting : ${meetings}" class="item"
                 th:onclick="|window.location.href='/meeting/detail/' + '${meeting.meetingNo}'|">
                <div class="item-image">
                    <img th:src="@{/img/{teamName}로고.png(teamName=${meeting.meetingTeamName})}" th:alt="${meeting.meetingTeamName}">
                    <div class="meeting-team">
                        <strong th:text="${meeting.meetingTeamName}"></strong>
                    </div>
                </div>
                <div class="item-content">
                    <div class="meeting-title">
                        <strong th:text="${meeting.meetingTitle}"></strong>
                    </div>
                    <div class="meeting-place">
                        <span th:text="${meeting.meetingPlace}"></span>
                    </div>
                    <div class="meeting-time">
                        <span th:text="${meeting.meetingTime}"></span>
                    </div>
                    <div class="meeting-max-people">
                        <span th:text="${attendeesCountMap[meeting.meetingNo]} + ' / ' + ${meeting.meetingMaxPeople} + '명'">0 / 10명</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="no-meetings" class="no-meetings" style="display: none;">
            개설된 소모임이 없습니다.
        </div>

        <!-- 페이지네이션 컨트롤 -->
        <div id="pagination" class="pagination">
            <!-- 페이지 번호가 여기에 동적으로 추가됩니다 -->
        </div>

    </div>
</main>

<footer class="footer-page">
    <div class="footer-content">
        <div class="logo">
            <img src="/img/고매치로고.png" alt="GoMatch 로고">
        </div>
        <div class="footer-text">
            <p>게인정보 처리방침</p>
            <p>(사)GoMatch｜서울 종구 남대문로 120 대경빌딩 3층｜02)1544-1515</p>
            <p>Copyright © GoMatch</p>
        </div>
    </div>
</footer>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemsPerPage = 10;
        let currentPage = 1;
        let totalPages = 1;
        let data = [];
        let selectedTeam = '전체';
        let selectedDate = new Date().toISOString().split('T')[0];
        const calendarEl = document.getElementById('calendar');
        let selectedDateElement = null;
        let gameDates = [];

        // 팀 필터 함수
        window.filterByTeam = function(team) {
            selectedTeam = team;
            currentPage = 1;
            document.querySelectorAll('.tag').forEach(tag => tag.classList.remove('active'));
            const selectedTag = document.querySelector(`.tag[onclick="filterByTeam('${team}')"]`);
            if (selectedTag) {
                selectedTag.classList.add('active');
            }
            loadMeetings();
        }

        // 소모임 개설하기 버튼 함수
        window.registerMeeting = function() {
            fetch('/meeting/checkLogin')
                .then(response => response.json())
                .then(data => {
                    if (data.loggedIn) {
                        window.location.href = '/meeting/register';
                    } else {
                        Swal.fire({
                            title: '로그인이 필요한 서비스입니다.',
                            text: '로그인을 하시겠습니까?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: '로그인',
                            cancelButtonText: '취소'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/member/loginpage';
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('로그인 상태 확인 중 오류 발생:', error);
                    Swal.fire('오류 발생', '로그인 상태 확인 중 오류가 발생했습니다.', 'error');
                });
        }

        // 서버에서 경기 날짜 가져오기
        fetch('/meeting/gameDates')
            .then(response => response.json())
            .then(dates => {
                gameDates = dates.map(date => new Date(date).toISOString().split('T')[0]);
                renderCalendar();
            })
            .catch(error => {
                console.error('경기 날짜 불러오기 중 오류 발생:', error);
                renderCalendar();
            });

        // 달력 렌더링 함수
        function renderCalendar() {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 'auto',
                contentHeight: 'auto',
                dayCellContent: function(e) {
                    e.dayNumberText = e.dayNumberText.replace('일', '');
                },
                // 지난 소모임 보여지지 않도록 하는 조건
                // validRange: {
                //     start: new Date().toISOString().split('T')[0]
                // },
                dateClick: function(info) {
                    selectedDate = info.dateStr;
                    currentPage = 1;
                    if (selectedDateElement) {
                        selectedDateElement.classList.remove('fc-day-selected');
                    }
                    selectedDateElement = info.dayEl;
                    selectedDateElement.classList.add('fc-day-selected');
                    loadMeetings();
                },
                dayCellDidMount: function(info) {
                    const dateStr = info.date.toISOString().split('T')[0];
                    const today = new Date().toISOString().split('T')[0];
                    // 지난 날짜는 필터 태그와 동일한 색상(#f0f0f0)으로 설정
                    if (dateStr < today) {
                        info.el.style.backgroundColor = '#f8f9fa';
                    }

                    // 경기 날짜 표시
                    if (gameDates.includes(dateStr)) {
                        info.el.classList.add('game-date');
                    }
                },
                datesSet: applyGameDates
            });
            calendar.render();
            loadMeetings();
        }

        // 달력의 경기 날짜에 스타일 적용
        function applyGameDates() {
            document.querySelectorAll('.fc-daygrid-day').forEach(dayCell => {
                const dateStr = dayCell.getAttribute('data-date');
                if (gameDates.includes(dateStr)) {
                    dayCell.classList.add('game-date');
                } else {
                    dayCell.classList.remove('game-date');
                }
            });
        }

        // 소모임 목록 불러오기 함수
        function loadMeetings() {
            const encodedTeam = encodeURIComponent(selectedTeam);
            const encodedDate = encodeURIComponent(selectedDate || "");

            fetch(`/meeting/listByDateAndTeam?date=${encodedDate}&team=${encodedTeam}`)
                .then(response => response.json())
                .then(fetchedData => {
                    data = fetchedData;
                    totalPages = Math.ceil(data.length / itemsPerPage);
                    renderMeetings();
                    renderPagination();
                    updateFilterInfo(); // 필터 정보 업데이트

                    document.getElementById("total-count").textContent = data.length;
                    document.getElementById("current-page").textContent = currentPage;
                    document.getElementById("total-pages").textContent = totalPages;
                })
                .catch(error => {
                    console.error('소모임 불러오기 중 오류 발생:', error);
                });
        }

        // 필터 정보 업데이트 함수
        function updateFilterInfo() {
            const filterInfo = `필터적용   [날짜] ${selectedDate}    [팀] ${selectedTeam}`;
            document.getElementById("filter-info").textContent = filterInfo;
        }

        // 소모임 목록 렌더링 함수
        function renderMeetings() {
            const meetingList = document.getElementById("meeting-list");
            meetingList.innerHTML = ''; // 기존 리스트 초기화

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, data.length);

            if (data.length === 0) {
                document.getElementById("no-meetings").style.display = 'block';
            } else {
                document.getElementById("no-meetings").style.display = 'none';
                for (let i = startIndex; i < endIndex; i++) {
                    const meetingData = data[i];
                    const meeting = meetingData.meeting;  // 소모임 정보
                    const currentAttendeesCount = meetingData.currentAttendeesCount;  // 참석자 수

                    const item = document.createElement("div");
                    item.classList.add("item");

                    item.setAttribute("onclick", `window.location.href='/meeting/detail/${meeting.meetingNo}'`);

                    fetch(`/meeting/gameInfo?gameNo=${meeting.gameNo}`)
                        .then(response => response.json())
                        .then(gameInfo => {
                            item.innerHTML = `
                        <div class="item-image">
                            <img src="${getTeamLogo(meeting.meetingTeamName)}" alt="${meeting.meetingTeamName}">
                            <div class="meeting-team">
                                <strong>${meeting.meetingTeamName}</strong>
                            </div>
                        </div>
                        <div class="item-content">
                            <div class="meeting-title">
                                <strong>${meeting.meetingTitle}</strong>
                            </div>
                            <div class="meeting-game-info">
                                <img src="/img/info.png" alt="경기 정보 아이콘" class="icon">
                                <span>${gameInfo.teamA} vs ${gameInfo.teamB} (${gameInfo.gameTime}, @ ${gameInfo.gameField})</span>
                            </div>
                            <div class="meeting-place">
                                <img src="/img/where.png" alt="모임 장소 아이콘" class="icon">
                                <span>${meeting.meetingPlace}</span>
                            </div>
                            <div class="meeting-time">
                                <img src="/img/when.png" alt="모임 시간 아이콘" class="icon">
                                <span>${meeting.meetingTime}</span>
                            </div>
                            <div class="meeting-max-people">
                                <img src="/img/who.png" alt="참석자정보 아이콘" class="icon">
                                <span>${currentAttendeesCount} / ${meeting.meetingMaxPeople}명</span>
                            </div>
                        </div>
                    `;
                            meetingList.appendChild(item);
                        })
                        .catch(error => {
                            console.error('경기 정보 가져오기 중 오류 발생:', error);
                        });
                }
            }
        }

        // 페이지네이션 렌더링
        function renderPagination() {
            const paginationContainer = document.getElementById("pagination");
            paginationContainer.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.classList.add("pagination-li");
                if (i === currentPage) {
                    li.classList.add("pagination-li-active");
                }

                const pageButton = document.createElement("a");
                pageButton.href = "#";
                pageButton.textContent = i;
                pageButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    currentPage = i;
                    renderMeetings();
                    renderPagination();
                    document.getElementById("current-page").textContent = currentPage;
                });

                li.appendChild(pageButton);
                paginationContainer.appendChild(li);
            }
        }

        // 팀별 로고 이미지 반환
        function getTeamLogo(meetingTeamName) {
            switch (meetingTeamName) {
                case 'KT': return '/img/KT로고.png';
                case 'LG': return '/img/LG로고.png';
                case 'NC': return '/img/NC로고.png';
                case 'SSG': return '/img/SSG로고.png';
                case '기아': return '/img/기아로고.png';
                case '두산': return '/img/두산로고.png';
                case '롯데': return '/img/롯데로고.png';
                case '삼성': return '/img/삼성로고.png';
                case '키움': return '/img/키움로고.png';
                case '한화': return '/img/한화로고.png';
                default: return '/img/default-logo.png';
            }
        }
    });
</script>



</body>
</html>
