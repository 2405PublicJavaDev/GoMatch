<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>승부예측</title>
    <link rel="stylesheet" href="/css/matchPredict.css">
    <link rel="stylesheet" href="/css/header-footer.css">
</head>
<body>
<th:block th:replace="fragments/header.html"></th:block>
<main class="main-content">
    <section class="prediction-section">
        <div class="btn-container">
            <div class="match-predict">
                <button class="match-predict-btn active" type="button">
                    <h2>승부 예측</h2>
                </button>
            </div>
            <form action="/myMatchPredict" method="get">
                <div class="myMatch-predict">
                    <button class="myMatch-predict-btn" type="submit">
                        <h2>나의 예측</h2>
                    </button>
                </div>
            </form>
        </div>
        <div class="date-selector">
            <!-- 날짜 선택기는 JavaScript로 동적 생성됩니다 -->
        </div>
        <ul class="game-list">
            <!-- 게임 목록은 JavaScript로 동적 생성됩니다 -->
        </ul>
    </section>

    <aside class="calendar-section">
        <div class="member-info" th:if="${memberInfo != null}">
            <div class="member-id" name="member-id">
                <div>
                    <img class="profile-img" src="/img/LG로고.png" alt="프로필 이미지"/>
                    <span th:text="${memberInfo.memberNickname}"></span>
                    <span>님 안녕하세요</span>
                </div>
            </div>
            <div class="exp-point">
                <span>현재 경험치는</span>
                <span th:text="${memberInfo.experiencePoints}"></span>
                <span>입니다.</span>
            </div>
            <div class="user-points">
                <span>전체 예측에서 </span>
                <span th:text="${memberInfo.rankPosition}"></span>
                <strong>상위
                    <span th:text="${rankPercent}"></span>% 입니다.
                </strong>
                <div class="progress-bar"></div>
            </div>
        </div>
        <div class="member-info" th:if="${memberInfo == null}">
            <div class="member-id" name="member-id">
                <button type="button" onclick="location.href='/member/loginpage'">로그인 하기</button>
            </div>
        </div>
        <h3 class="calendar-title"></h3>
        <div class="calendar-week"></div>

        <div class="top-predictors">
            <ol>
                <h4>랭킹</h4>
                <div class="info">
                    <div>순위</div>
                    <div>닉네임</div>
                    <div>경험치</div>
                </div>
                <li th:each="member : ${memberRank}" class="rank-item">
                    <div class="rank-position">
                        <span th:text="${member.rankPosition}" class="rank"></span>
                    </div>
                    <span th:text="${member.memberNickname}" class="name"></span>
                    <span th:text="${member.experiencePoints}" class="points"></span>
                </li>
            </ol>
        </div>
        <div class="select-list">
            <button class="load-more">10위 더보기 ></button>
        </div>
    </aside>
</main>
<div class="team-logos">
    <div class="team-logos-container">
        <a href="#"><img src="/img/LG로고.png" alt="Twins" class="team-logo"></a>
        <a href="#"><img src="/img/KT로고.png" alt="Kiwiz" class="team-logo"></a>
        <a href="#"><img src="/img/SSG로고.png" alt="Landers" class="team-logo"></a>
        <a href="#"><img src="/img/NC로고.png" alt="Dinos" class="team-logo"></a>
        <a href="#"><img src="/img/두산로고.png" alt="Bears" class="team-logo"></a>
        <a href="#"><img src="/img/기아로고.png" alt="Tigers" class="team-logo"></a>
        <a href="#"><img src="/img/롯데로고.png" alt="Giants" class="team-logo"></a>
        <a href="#"><img src="/img/삼성로고.png" alt="Lions" class="team-logo"></a>
        <a href="#"><img src="/img/한화로고.png" alt="Wiz" class="team-logo"></a>
        <a href="#"><img src="/img/키움로고.png" alt="Heroes" class="team-logo"></a>
    </div>
</div>

<th:block th:replace="fragments/footer.html"></th:block>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        var errorMessage = /*[[${errorMessage}]]*/ null;
        if (errorMessage) {
            alert(errorMessage);
        }

        const today = new Date();
        const dateSelector = document.querySelector('.date-selector');

        // 7일 간의 날짜 버튼 생성
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);

            const button = document.createElement('button');
            button.classList.add('date');

            let dateString = date.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' }).replace(/\./g, '');

            if (i === 0) {
                button.classList.add('active');
                button.innerText = `오늘\n ${dateString}`;
            } else {
                button.innerText = dateString;
            }
            dateSelector.appendChild(button);

            button.addEventListener('click', function () {
                document.querySelectorAll('.date').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                const selectedDate = date.toISOString().split('T')[0];
                fetchPredictionsByDate(selectedDate);
            });
        }

        function setPrediction(decision, gameNo) {
            fetch('/addPredict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    gameNo: gameNo,
                    matchPredictNo: 1,
                    matchPredictDecision: decision
                })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText) });
                    }
                    return response.text();
                })
                .then(data => {
                    alert(data || "예측이 성공적으로 등록되었습니다.");
                    updateUIAfterPrediction(gameNo, decision);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('오류: ' + (error.message || "예측 등록 중 문제가 발생했습니다."));
                });
        }

        function updateUIAfterPrediction(gameNo, decision) {
            const gameElement = document.querySelector(`[data-game-no="${gameNo}"]`);
            if (gameElement) {
                const buttons = gameElement.querySelectorAll('.team-a, .draw, .team-b');
                buttons.forEach(button => {
                    button.disabled = true;
                    button.classList.remove('active'); // 모든 버튼에서 active 클래스 제거
                    if (button.textContent.trim() === decision || (decision === '무' && button.classList.contains('draw'))) {
                        button.classList.add('selected', 'active'); // 선택된 버튼에 selected와 active 클래스 추가
                    }
                });
            }
        }

        function fetchPredictionsByDate(date) {
            console.log(`Fetching predictions for date: ${date}`);
            fetch(`/matchPredict/list/${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const gameList = document.querySelector('.game-list');
                    gameList.innerHTML = '';

                    data.forEach(predict => {
                        const listItem = document.createElement('li');
                        listItem.className = 'game-item';
                        listItem.dataset.gameNo = predict.gameNo;
                        listItem.innerHTML = `
                    <span class="league">
                        <img src="/img/고매치로고.png">
                        GoMatch
                    </span>
                    <div class="upcoming-games">
                          <div class="game-date">
                            <p>경기 날짜</p>
                            <span th:text="${predict.gameDate}" class="date">${predict.gameDate}</span>
                          </div>
                          <div class="game-time">
                            <p th:text="${predict.gameTime}" class="time">${predict.gameTime}</p>
                            <span>경기 예정</span>
                          </div>
                        </div>
                    <div class="teams">
                        <button type="button" class="team-a ${predict.matchPredictDecision === predict.teamA ? 'active' : ''}" ${predict.hasPrediction ? 'disabled' : ''}>
                            <span>${predict.teamA}</span>
                            <img class="teamA-img" src="/img/KT로고.png" alt="a팀 로고">
                        </button>
                        <button type="button" class="draw ${predict.matchPredictDecision === '무' ? 'active' : ''}" ${predict.hasPrediction ? 'disabled' : ''}>
                            <span class="vs">무승부</span>
                        </button>
                        <button type="button" class="team-b ${predict.matchPredictDecision === predict.teamB ? 'active' : ''}" ${predict.hasPrediction ? 'disabled' : ''}>
                            <img class="teamB-img" src="/img/LG로고.png" alt="b팀 로고">
                            <span>${predict.teamB}</span>
                        </button>
                    </div>
                `;
                        gameList.appendChild(listItem);
                    });
                })
                .catch(error => console.error('Error fetching predictions by date:', error));
        }

        // function fetchPredictionsByDate(date) {
        //     console.log(`Fetching predictions for date: ${date}`);
        //     fetch(`/matchPredict/list/${date}`)
        //         .then(response => {
        //             if (!response.ok) {
        //                 throw new Error(`HTTP error! Status: ${response.status}`);
        //             }
        //             return response.json();
        //         })
        //         .then(data => {
        //             console.log(data);
        //             const gameList = document.querySelector('.game-list');
        //             gameList.innerHTML = '';
        //
        //             data.forEach(predict => {
        //                 const listItem = document.createElement('li');
        //                 listItem.className = 'game-item';
        //                 listItem.dataset.gameNo = predict.gameNo;
        //                 listItem.innerHTML = `
        //                     <span class="league">
        //                         <img src="/img/고매치로고.png">
        //                         GoMatch
        //                     </span>
        //                     <div class="upcoming-games">
        //                         <span class="time">${predict.gameTime}</span>
        //                         <p>경기 예정</p>
        //                         <span class="time-out">후 종료</span>
        //                     </div>
        //                     <div class="teams">
        //                         <button type="button" class="team-a" ${predict.hasPrediction ? 'disabled' : ''}>
        //                             <span>${predict.teamA}</span>
        //                             <img class="teamA-img" src="/img/KT로고.png" alt="a팀 로고">
        //                         </button>
        //                         <button type="button" class="draw" ${predict.hasPrediction ? 'disabled' : ''}>
        //                             <span class="vs">무승부</span>
        //                         </button>
        //                         <button type="button" class="team-b" ${predict.hasPrediction ? 'disabled' : ''}>
        //                             <img class="teamB-img" src="/img/LG로고.png" alt="b팀 로고">
        //                             <span>${predict.teamB}</span>
        //                         </button>
        //                     </div>
        //                 `;
        //                 gameList.appendChild(listItem);
        //             });
        //         })
        //         .catch(error => console.error('Error fetching predictions by date:', error));
        // }

        // 이벤트 위임을 사용한 예측 버튼 클릭 처리
        document.querySelector('.game-list').addEventListener('click', function(event) {
            const button = event.target.closest('button');
            if (button && !button.disabled && (button.classList.contains('team-a') || button.classList.contains('draw') || button.classList.contains('team-b'))) {
                const gameNo = button.closest('.game-item').dataset.gameNo;
                const decision = button.classList.contains('draw') ? '무' : button.querySelector('span').textContent;
                setPrediction(decision, gameNo);
            }
        });

        const todayISO = today.toISOString().split('T')[0];
        fetchPredictionsByDate(todayISO);

        // 랭킹 더보기 기능
        let loadMoreBtn = document.querySelector(".load-more");
        const allRankItems = document.querySelectorAll(".rank-item");

        let initialDisplayCount = document.querySelector(".member-info") ? 3 : 3;

        allRankItems.forEach((item, index) => {
            if (index >= initialDisplayCount) {
                item.style.display = "none";
            }
        });

        loadMoreBtn.addEventListener("click", function() {
            let shownCount = 0;
            allRankItems.forEach(item => {
                if (shownCount < 10 && item.style.display === "none") {
                    item.style.display = "flex";
                    shownCount++;
                }
            });
            if (shownCount < 10) {
                loadMoreBtn.style.display = "none";
            }
        });

        loadMoreBtn.textContent = isExpanded ? "더보기 >" : "접기 <";
    });
</script>
</body>
</html>