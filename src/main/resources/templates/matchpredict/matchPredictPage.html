<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>승부예측</title>
    <link rel="stylesheet" href="/css/matchPredict.css">
    <link rel="stylesheet" href="/css/header-footer.css">
</head>
<body>
<th:block th:replace="fragments/header.html"></th:block>
<main class="main-content">
    <section class="prediction-section">
        <div class="btn-container">
            <div class="match-predict">
            <button class="match-predict-btn" type="button">
                <h2>승부 예측</h2>
            </button>
            </div>
            <form action="/myMatchPredict" method="get">
                <div class="myMatch-predict">
                    <button class="myMatch-predict-btn" type="submit">
                        <h2>나의 예측</h2>
                    </button>
                </div>
            </form>
        </div>
        <div class="date-selector">

        </div>
        <ul class="game-list">
            <li th:each="predict : ${matchPredictions}" class="game-item">
                <span class="league">
                    <img src="/img/고매치로고.png">
                    GoMatch
                </span>
                <div class="upcoming-games">
                    <div class="game-date">
                        <p>경기 날짜</p>
                        <span th:text="${predict.gameDate}" class="date"></span>
                    </div>
                    <div class="game-time">
                        <p th:text="${predict.gameTime}" class="time"></p>
                        <span>경기 예정</span>
                    </div>
                </div>
                <form name="add-form" action="/addPredict" method="post">
<!--                    <input type="date" name="gameDate" required>-->
                    <input type="hidden" name="memberId" th:value="${predict.memberId}"/>
                    <input type="hidden" name="gameNo" th:value="${predict.gameNo}"/>
                    <input type="hidden" name="matchPredictNo" th:value="1">
                    <input type="hidden" name="matchPredictDecision" id="matchPredictDecision"/>
                    <div class="teams">
                        <button type="button" class="team-a" th:onclick="setPrediction([[${predict.teamA}]],[[${predict.gameNo}]])">
                            <span th:text="${predict.teamA}"></span>
                            <img class="teamA-img" src="/img/KT로고.png" alt="a팁 로고">
                        </button>
                        <button type="button" class="draw" th:onclick="setPrediction('무',[[${predict.gameNo}]]))">
                            <span class="vs">무승부</span>
                        </button>
                        <button type="button" class="team-b" th:onclick="setPrediction([[${predict.teamB}]],[[${predict.gameNo}]])">
                            <img class="teamB-img" src="/img/LG로고.png" alt="b팁 로고">
                            <span th:text="${predict.teamB}"></span>
                        </button>
                    </div>
                </form>
            </li>
        </ul>
    </section>

    <aside class="calendar-section">
        <div class="member-info" th:if="${memberInfo != null}">
            <div class="member-id" name="member-id">
                <div>
                    <img class="profile-img" src="/img/LG로고.png" alt="프로필 이미지"/>
                    <span th:text="${memberInfo.memberNickname}"></span>
                    <span>님 안녕하세요</span>
                </div>
            </div>
            <div class="exp-point">
                <span>현재 경험치는</span>
                <span th:text="${memberInfo.experiencePoints}"></span>
                <span>입니다.</span>
            </div>
            <div class="user-rank">
                <span>현재 순위는</span>
                <span th:text="${memberInfo.rankPosition}">-위 </span>
                <span>위 입니다.</span>
            </div>
            <div class="user-points">
                <span>전체 예측에서 </span>
                <strong><span th:text="${memberInfo.rankPosition}"></span></strong>위 상위
                <span th:text="${rankPercent}"></span>% 입니다.
                <div class="progress-bar"></div>
            </div>
        </div>
        <div class="member-info" th:if="${memberInfo == null}">
            <div class="member-id" name="member-id">
                <button type="button" onclick="location.href='/member/loginpage'">로그인 하기</button>
            </div>
        </div>
        <h3 class="calendar-title"></h3>
        <div class="calendar-week"></div>

        <div class="top-predictors">
            <ol>
                <h4>랭킹</h4>
                    <li th:if="${memberInfo != null}" class="rank-item">
                        <div class="rank-position">
                            <img class="profile-img" src="/img/LG로고.png" alt="profile-img">
                            <span th:text="${memberInfo.rankPosition}" class="rank"></span>
                        </div>
                        <span th:text="${memberInfo.memberNickname}" class="name"></span>
                        <span>(나)</span>
                        <span th:text="${memberInfo.experiencePoints}" class="points"></span>
                    </li>

                    <li th:each="member : ${memberRank}" class="rank-item">
                        <div class="rank-position">
                            <img class="profile-img" src="/img/LG로고.png" alt="profile-img">
                            <span th:text="${member.rankPosition}" class="rank"></span>
                        </div>
                        <span th:text="${member.memberNickname}" class="name"></span>
                        <span th:text="${member.experiencePoints}" class="points"></span>
                    </li>
            </ol>
        </div>
        <div class="select-list">
            <button class="load-more">10위 더보기 ></button>
        </div>
    </aside>
</main>
<div class="team-logos">
    <div class="team-logos-container">
        <a href="#"><img src="img/LG로고.png" alt="Twins" class="team-logo"></a>
        <a href="#"><img src="img/KT로고.png" alt="Kiwiz" class="team-logo"></a>
        <a href="#"><img src="img/SSG로고.png" alt="Landers" class="team-logo"></a>
        <a href="#"><img src="img/NC로고.png" alt="Dinos" class="team-logo"></a>
        <a href="#"><img src="img/두산로고.png" alt="Bears" class="team-logo"></a>
        <a href="#"><img src="img/기아로고.png" alt="Tigers" class="team-logo"></a>
        <a href="#"><img src="img/롯데로고.png" alt="Giants" class="team-logo"></a>
        <a href="#"><img src="img/삼성로고.png" alt="Lions" class="team-logo"></a>
        <a href="#"><img src="img/한화로고.png" alt="Wiz" class="team-logo"></a>
        <a href="#"><img src="img/키움로고.png" alt="Heroes" class="team-logo"></a>
    </div>
</div>

<th:block th:replace="fragments/footer.html"></th:block>
<script th:inline="javascript">
    var errorMessage = /*[[${errorMessage}]]*/ null;
    if (errorMessage) {
        alert(errorMessage);
    }

    function setPrediction(decision, gameNo, teamButton) {
        const decisionInput = document.querySelector("input[name='matchPredictDecision']");
        if (decisionInput) {
            decisionInput.value = decision;
        }
        const gameNoInput = document.querySelector("input[name='gameNo']");
        if (gameNoInput) {
            gameNoInput.value = gameNo;
        }
        const form = document.forms["add-form"];
        if (form) {
            form.submit();
        }

        // 팀 버튼 활성화
        const parentGameItem = teamButton.closest(".game-item");
        const siblingButtons = parentGameItem.querySelectorAll(".team-a, .draw, .team-b");
        siblingButtons.forEach(function (btn) {
            btn.classList.remove("active");
        });
        teamButton.classList.add("active");
    }

    document.addEventListener("DOMContentLoaded", function () {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        const options = { month: '2-digit', day: '2-digit' };

        const dateSelector = document.querySelector('.date-selector');

        // 7일 간의 날짜 버튼 생성
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);

            const button = document.createElement('button');
            button.classList.add('date');

            let dateString = date.toLocaleDateString('ko-KR', options).replace(/\./g, '');

            if (i === 0) {
                button.classList.add('active');
                button.innerText = `오늘\n ${dateString}`;
            } else {
                button.innerText = dateString;
            }
            dateSelector.appendChild(button);

            button.addEventListener('click', function () {
                const allButtons = document.querySelectorAll('.date');
                allButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                const selectedDate = date.toISOString().split('T')[0];
                fetchPredictionsByDate(selectedDate);
            });
        }

        // 주차 계산 및 버튼 생성
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);

        const calendarWeek = document.querySelector('.calendar-week');
        calendarWeek.innerHTML = '';
        let weekCount = 1;

        for (let d = new Date(firstDay); d <= today; d.setDate(d.getDate() + 7)) {
            const weekStart = new Date(d);
            const weekEnd = new Date(d);
            weekEnd.setDate(weekEnd.getDate() + 6);

            if (weekEnd > lastDay) {
                weekEnd.setDate(lastDay.getDate());
            }

            const button = document.createElement('button');
            button.className = 'week-date';
            button.type = 'button';
            button.textContent = `${currentMonth + 1}월 ${weekCount}주`;

            // 각 버튼에 시작 날짜와 종료 날짜 데이터 추가
            button.dataset.startDate = weekStart.toISOString().split('T')[0];
            button.dataset.endDate = weekEnd.toISOString().split('T')[0];

            if (today >= weekStart && today <= weekEnd) {
                button.classList.add('active');
            }

            calendarWeek.appendChild(button);
            weekCount++;

            if (weekEnd >= today) {
                break;
            }
        }

        function fetchPredictionsByDate(date) {
            console.log(`Fetching predictions for date: ${date}`);
            fetch(`/matchPredict/list/${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    const gameList = document.querySelector('.game-list');
                    gameList.innerHTML = '';

                    data.forEach(predict => {
                        const listItem = document.createElement('li');
                        listItem.className = 'game-item';
                        listItem.innerHTML = `
                            <span class="league">
                                <img src="/img/고매치로고.png">
                                GoMatch
                            </span>
                            <div class="upcoming-games">
                                <span class="time">${predict.gameTime}</span>
                                <p>경기 예정</p>
                                <span class="time-out">후 종료</span>
                            </div>
                            <form name="add-form" action="/addPredict" method="post">
                                <input type="hidden" name="memberId" value="${predict.memberId}"/>
                                <input type="hidden" name="gameNo" value="${predict.gameNo}"/>
                                <input type="hidden" name="matchPredictNo" value="1"/>
                                <input type="hidden" name="matchPredictDecision" id="matchPredictDecision"/>
                                <div class="teams">
                                    <button type="button" class="team-a" onclick="setPrediction('${predict.teamA}', '${predict.gameNo}')">
                                        <span>${predict.teamA}</span>
                                        <img class="teamA-img" src="/img/KT로고.png" alt="a팁 로고">
                                    </button>
                                    <button type="button" class="draw" onclick="setPrediction('무', '${predict.gameNo}')">
                                        <span class="vs">무승부</span>
                                    </button>
                                    <button type="button" class="team-b" onclick="setPrediction('${predict.teamB}', '${predict.gameNo}')">
                                        <img class="teamB-img" src="/img/LG로고.png" alt="b팁 로고">
                                        <span>${predict.teamB}</span>
                                    </button>
                                </div>
                            </form>
                        `;
                        gameList.appendChild(listItem);
                    });
                })
                .catch(error => console.error('Error fetching predictions by date:', error));
        }

        const todayISO = today.toISOString().split('T')[0];
        fetchPredictionsByDate(todayISO);

        let loadMoreBtn = document.querySelector(".load-more");
        const allRankItem = document.querySelectorAll(".rank-item");

        let initialDisplayCount = document.querySelector(".member-info").value ? 4 : 3;

        allRankItem.forEach((item, index) => {
            if (index >= initialDisplayCount) {
                item.style.display = "none";
            }
        });

        loadMoreBtn.addEventListener("click", function() {
            let shownCount = 0;
            allRankItem.forEach(item => {
                if (shownCount < 10 && item.style.display === "none") {
                    item.style.display = "flex";
                    shownCount++;
                }
            });
            if (shownCount < 10) {
                loadMoreBtn.style.display = "none";
            }
        });

        const matchPredictBtn = document.querySelector(".match-predict-btn");
        const myMatchPredictBtn = document.querySelector(".myMatch-predict-btn");

        matchPredictBtn.classList.add("active");

        matchPredictBtn.addEventListener("click", function () {
            matchPredictBtn.classList.add("active");
            myMatchPredictBtn.classList.remove("active");
        });

        myMatchPredictBtn.addEventListener("click", function () {
            myMatchPredictBtn.classList.add("active");
            matchPredictBtn.classList.remove("active");
            const memberId = document.querySelector("#memberId");
            if (memberId) {
                location.href = "myMatchPredictPage.html?memberId=" + encodeURIComponent(memberId);
            } else {
                console.error("유효하지 않은 memberId 입니다.");
            }
        });

        const todayButton = document.querySelector(".date.active");
        todayButton.classList.add("active");

        const dateButtons = document.querySelectorAll(".date");
        dateButtons.forEach(function (dateButton) {
            dateButton.addEventListener("click", function () {
                dateButtons.forEach(function (btn) {
                    btn.classList.remove("active");
                });
                this.classList.add("active");
            });
        });

        const teamsButtons = document.querySelectorAll(".team-a, .draw, .team-b");
        teamsButtons.forEach(function (teamButton){
            teamButton.addEventListener("click", function (){
                const parentGameItem = this.closest(".game-item");
                const siblingButtons = parentGameItem.querySelectorAll(".team-a, .draw, .team-b");
                siblingButtons.forEach(function (btn){
                    btn.classList.remove("active");
                });
                this.classList.add("active");
            });
        });

        const weekButtons = document.querySelectorAll(".week-date");
        weekButtons.forEach(function (weekButton) {
            weekButton.addEventListener("click", function () {
                weekButtons.forEach(function (btn) {
                    btn.classList.remove("active");
                });
                this.classList.add("active");

                // 클릭된 주차의 랭킹 리스트 조회
                const startDate = this.dataset.startDate;
                const endDate = this.dataset.endDate;
                fetchRankingList(startDate,endDate);
            });
        });

        // 랭킹 리스트 조회 함수
        function fetchRankingList(startDate, endDate) {
            fetch(`/rankingList/${startDate}/${endDate}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Http error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateRankingList(data);
                })
                .catch(error => console.error(`Error fetching ranking list:`, error));
        }

        function updateRankingList(ranking) {
            const rankingList = document.querySelector(".top-predictors ol");
            rankingList.innerHTML = '<h4>랭킹</h4>'; // 기존 리스트 초기화

            ranking.forEach((member, index) => { // forEach로 순회
                const listItem = document.createElement("li"); // li 요소 생성
                listItem.className = "rank-item";
                listItem.innerHTML = `
            <div class="rank-position">
                <img class="profile-img" src="/img/LG로고.png" alt="profile-img">
                <span class="rank">${index + 1}</span>
            </div>
            <span class="name">${member.memberNickname}</span>
            <span class="points">${member.experiencePoints}</span>
        `;
                rankingList.appendChild(listItem); // 리스트에 추가
            });
        }


        const initialWeekButton = document.querySelector(".week-date.active");
        if (initialWeekButton) {
            const startDate = initialWeekButton.dataset.startDate;
            const endDate = initialWeekButton.dataset.endDate;
            fetchRankingList(startDate, endDate);
        }
    });
</script>
</body>
</html>