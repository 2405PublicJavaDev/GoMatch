<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moijo.gomatch.domain.matchpredict.mapper.MatchPredictMapper">
    <select id="selectAllMatchByMember" resultType="MatchPredict">
        SELECT P.MATCH_PREDICT_NO,
               G.GAME_NO,
               P.MATCH_PREDICT_DECISION,
               G.TEAM_A,
               G.TEAM_B,
               G.GAME_TIME,
               P.MATCH_PREDICT_STATUS,
               G.GAME_DATE,
               G.REG_DATE
        FROM GAME G
        JOIN MATCH_PREDICT P
        ON G.GAME_NO = P.GAME_NO
        WHERE G.GAME_NO = #{gameNo}
    </select>

    <select id="selectPredictByDate" resultType="MatchPredict">
        SELECT
            G.GAME_NO,
            P.MATCH_PREDICT_NO,
            P.MATCH_PREDICT_DECISION,
            G.TEAM_A,
            G.TEAM_B,
            G.GAME_TIME,
            P.MATCH_PREDICT_STATUS,
            G.GAME_DATE,
            G.REG_DATE
        FROM
            GAME G
                LEFT JOIN
            MATCH_PREDICT P ON G.GAME_NO = P.GAME_NO
        WHERE
            G.GAME_DATE = #{gameDate}
    </select>

    <select id="selectAllMemberRank" resultType="MemberRankDTO">
        SELECT U.MEMBER_ID,M.MEMBER_NAME,M.MEMBER_NICKNAME,U.EXPERIENCE_POINTS,U.RANK_POSITION
        FROM MEMBER M
        FULL OUTER JOIN USER_RANK U
        ON M.MEMBER_ID = U.MEMBER_ID
        ORDER BY U.RANK_POSITION
    </select>

    <select id="selectAllMyMatchByMember" resultType="MyPredictDTO">
        SELECT P.MATCH_PREDICT_NO,
               G.GAME_NO,
               P.MATCH_PREDICT_DECISION,
               M.MEMBER_ID,
               G.TEAM_A,
               G.TEAM_B,
               G.GAME_TIME,
               P.MATCH_PREDICT_STATUS,
               G.GAME_DATE,
               G.REG_DATE
        FROM GAME G
                 LEFT JOIN MATCH_PREDICT P
                           ON G.GAME_NO = P.GAME_NO
                 LEFT JOIN MEMBER M
                           ON P.MEMBER_ID = M.MEMBER_ID
        WHERE M.MEMBER_ID = #{memberId}
    </select>

    <select id="selectMemberInfo" resultType="MemberDTO">
        SELECT
            U.MEMBER_ID,
            M.MEMBER_NICKNAME,
            M.MEMBER_NAME,
            U.RANK_POSITION,
            U.EXPERIENCE_POINTS
        FROM USER_RANK U
                 JOIN MEMBER M ON M.MEMBER_ID = U.MEMBER_ID
        WHERE M.MEMBER_ID = #{memberId}
    </select>

    <select id="countPredictionsByMemberId" resultType="Integer">
        SELECT COUNT(*) FROM MATCH_PREDICT WHERE GAME_NO = #{gameNo} AND MEMBER_ID = #{memberId}
    </select>

    <select id="getTotalMemberCount" resultType="Long">
        SELECT COUNT(*) FROM MEMBER
    </select>

    <select id="getOneByMemberRank" resultType="Long">
        SELECT RANK_POSITION FROM USER_RANK
        WHERE MEMBER_ID = #{memberId}
    </select>

    <select id="checkPredictionResult" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM MATCH_PREDICT
        WHERE MEMBER_ID = #{memberId}
          AND GAME_NO = #{gameNo}
          AND MATCH_PREDICT_DECISION = (
            SELECT GAME_RESULT
            FROM GAME
            WHERE GAME_NO = #{gameNo}
        )
    </select>

    <select id="getAllMemberRankUpdate" resultType="MemberRankDTO">
        SELECT
            M.MEMBER_ID,
            M.MEMBER_NICKNAME,
            SUM(U.EXPERIENCE_POINTS) AS experiencePoints,
            U.RANK_POSITION
        FROM
            USER_RANK U
                JOIN
            MEMBER M ON U.MEMBER_ID = M.MEMBER_ID
                JOIN
            MATCH_PREDICT P ON P.MEMBER_ID = M.MEMBER_ID
                JOIN
            GAME G ON G.GAME_NO = P.GAME_NO
        WHERE
            G.GAME_DATE BETWEEN #{startDate} AND #{endDate}
        GROUP BY
            M.MEMBER_ID, M.MEMBER_NICKNAME, U.RANK_POSITION
        ORDER BY
            experiencePoints DESC;  -- 경험치 총합 기준으로 정렬
    </select>



    <insert id="insertMatchPredict">
        INSERT INTO MATCH_PREDICT (MATCH_PREDICT_NO,GAME_NO,MATCH_PREDICT_DECISION,MEMBER_ID,MATCH_PREDICT_STATUS,REG_DATE)
        VALUES (SEQ_MATCH_PREDICT.NEXTVAL,#{gameNo},#{matchPredictDecision},#{memberId} ,DEFAULT,SYSDATE)
    </insert>

<!--    <insert id="insertMemberRanking">-->
<!--        INSERT INTO USER_RANK (RANK_NO,MEMBER_ID,EXPERIENCE_POINTS,RANK_POSITION,REG_DATE,UPDATE_DATE)-->
<!--        VALUES (SEQ_USER_RANK.NEXTVAL,#{memberId},#{experiencePoints},#{rankPosition},SYSDATE,SYSDATE)-->
<!--    </insert>-->

    <update id="updateMatchPredict">
        UPDATE MATCH_PREDICT
        SET MATCH_PREDICT_DECISION = #{matchPredictDecision}
        WHERE GAME_NO = #{gameNo} AND MEMBER_ID = #{memberId}
    </update>


</mapper>